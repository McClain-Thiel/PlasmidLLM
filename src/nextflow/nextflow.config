/*
 * SPACE Pipeline Configuration
 * Scalable Plasmid Annotation & Classification Engine
 */

params {
    // Input/Output
    input_pattern   = "${projectDir}/../../tests/data/*.{gb,gbk,fasta,fa,json}"
    outdir          = "results"

    // Database paths
    bakta_db        = "${projectDir}/databases/bakta"
    copla_db        = "${projectDir}/databases/copla"

    // Processing options
    threads         = 4
    skip_bakta      = false
    skip_mobsuite   = false
    skip_copla      = false
    skip_qc         = false
}

profiles {
    standard {
        process.executor = 'local'
    }

    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }

    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
    }

    local {
        // For running with locally installed tools
        process.executor = 'local'
    }

    test {
        params.input_pattern = "${projectDir}/../../tests/data/*.gbk"
        params.outdir = "test_results"
    }
}

// Process-specific containers and resources
process {
    // Default for Python scripts
    withLabel: 'python' {
        container = 'space-pipeline:latest'
        cpus = 1
        memory = '2 GB'
    }

    // Normalization
    withName: 'NORMALIZE' {
        container = 'space-pipeline:latest'
        cpus = 1
        memory = '2 GB'
    }

    // Track 1: Engineered scan (PlasmidKit)
    withName: 'SCAN_ENGINEERED' {
        container = 'space-pipeline:latest'
        cpus = 1
        memory = '2 GB'
    }

    // Track 2: Natural scan
    withName: 'RUN_BAKTA' {
        container = 'oschwengers/bakta:latest'
        cpus = { params.threads }
        memory = '8 GB'
    }

    withName: 'RUN_MOBSUITE' {
        container = 'staphb/mob_suite:latest'
        cpus = { params.threads }
        memory = '4 GB'
    }

    withName: 'RUN_COPLA' {
        container = 'cgetools/copla:latest'
        cpus = 2
        memory = '4 GB'
    }

    withName: 'PARSE_NATURAL' {
        container = 'space-pipeline:latest'
        cpus = 1
        memory = '2 GB'
    }

    // Track 3: QC
    withName: 'SEQ_QC' {
        container = 'space-pipeline:latest'
        cpus = 1
        memory = '1 GB'
    }

    // Classifier
    withName: 'CLASSIFY' {
        container = 'space-pipeline:latest'
        cpus = 1
        memory = '1 GB'
    }

    // Export
    withName: 'EXPORT_PARQUET' {
        container = 'space-pipeline:latest'
        cpus = 1
        memory = '4 GB'
    }

    // Database setup
    withName: 'DOWNLOAD_BAKTA_DB' {
        container = 'oschwengers/bakta:latest'
        cpus = 1
        memory = '4 GB'
    }
}

// Manifest
manifest {
    name            = 'SPACE'
    author          = 'Plasmid Pretraining Project'
    description     = 'Scalable Plasmid Annotation & Classification Engine'
    version         = '0.1.0'
    nextflowVersion = '>=23.04.0'
    mainScript      = 'main.nf'
}

// Execution reports
timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/timeline.html"
    overwrite = true
}

report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/report.html"
    overwrite = true
}

trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/trace.txt"
    overwrite = true
}

dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/dag.svg"
    overwrite = true
}
